<div class= "container py-5">


  <h1>Tableau de suivi</h1>
  <h2><%= @broker.firstname%>, bienvenue sur ta page de suivi de tes contacts</h2>


  <div class="row mt-5">
  <div class="col-lg-4 col-12">
      <div class="card" >
        <div class="card-body">
          <h5 class="card-title">Aujourd'hui</h5>
          <p class="card-text"><span style="font-size: 2rem"><%= @subscribers.select{|x| x.created_at > Date.today.beginning_of_day}.count%></span></p>
          <div class= "row">
            <div class="col-4"> <%= @subscribers.select{|x| x.hot_lead && x.created_at > Date.today.beginning_of_day}.count %> <br> <span class="badge badge-danger">Hot</span> </div>
            <div class="col-4"> <%= @subscribers.select{|x| !x.hot_lead && !x.is_broker_affiliated && x.created_at > Date.today.beginning_of_day}.count %>  <br> <span class="badge badge-light">Froid</span> </div>
            <div class="col-4"> <%= @subscribers.select{|x| x.is_broker_affiliated && x.created_at > Date.today.beginning_of_day}.count %> <br>  <span class="badge badge-info">Client</span> </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-12">
      <div class="card" >
        <div class="card-body">
          <h5 class="card-title">Cette semaine</h5>
          <p class="card-text"><span style="font-size: 2rem"><%= @subscribers.select{|x| x.created_at > Date.today.beginning_of_week}.count%></span></p>
          <div class= "row">
            <div class="col-4"> <%= @subscribers.select{|x| x.hot_lead && x.created_at > Date.today.beginning_of_week}.count %> <br> <span class="badge badge-danger">Hot</span> </div>
            <div class="col-4"> <%= @subscribers.select{|x| !x.hot_lead && !x.is_broker_affiliated && x.created_at > Date.today.beginning_of_week}.count %>  <br> <span class="badge badge-light">Froid</span> </div>
            <div class="col-4"> <%= @subscribers.select{|x| x.is_broker_affiliated && x.created_at > Date.today.beginning_of_week}.count %> <br>  <span class="badge badge-info">Client</span> </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Total</h5>
          <p class="card-text"><span style="font-size: 2rem"><%= @subscribers.count%></span></p>
          <div class= "row">
            <div class="col-4"> <%= @subscribers.select{|x| x.hot_lead}.count %> <br> <span class="badge badge-danger">Hot</span> </div>
            <div class="col-4"> <%= @subscribers.select{|x| !x.hot_lead && !x.is_broker_affiliated}.count %>  <br> <span class="badge badge-light">Froid</span> </div>
            <div class="col-4"> <%= @subscribers.select{|x| x.is_broker_affiliated}.count %> <br>  <span class="badge badge-info">Client</span> </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-3 d-flex flex-column">
    <h5>Légende</h5>
    <ul style="list-style:none">
      <li><span class="badge badge-danger">Hot</span> : Utilisateur qui a demandé à être mis en relation avec son courtier</li>
      <li><span class="badge badge-light">Froid</span> : Utilisateur qui n'a pas (encore) demandé à être mis en relation avec son courtier</li>
      <li><span class="badge badge-info">Client</span> : Votre client, à qui vous avez donné accès à l'alerte Ding Dong</li>
    </ul>
  </div>

  <div class="row mt-5">
    <table class="table">
      <thead class="thead-dark">
        <tr>
          <th scope="col">Status</th>
          <th scope="col">Nom</th>
          <th scope="col">Inscription</th>
          <th scope="col">Actif ?</th>
          <th scope="col">Plus</th>
        </tr>
      </thead>
      <tbody>
      <% @subscribers.each do |subscriber| %>
        <tr>
          <th scope="row">
            <% if subscriber.hot_lead  %>
              <span class="badge badge-danger">Hot</span>
            <%elsif subscriber.is_broker_affiliated%>
              <span class="badge badge-info">Client</span>
            <%else%>
              <span class="badge badge-light">Froid</span>
            <%end%>
          </th>
          <td><%= subscriber.get_fullname%></td>
          <td><%= subscriber.created_at.strftime("%d %B %Y")%></td>
          <td>
          <% if subscriber.is_active %>
              <span class="badge badge-pill badge-success">Oui</span>
            <%else%>
              <span class="badge badge-light">Non</span>
            <%end%>
          </td>
          <td>
            <button type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#subscriber-<%= subscriber.id%>">
            Voir plus
          </button>
          </td>
        </tr>
        <tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <% @subscribers.each do |subscriber| %>
    <!-- Subscriber Modal -->
    <div class="modal fade" id="subscriber-<%= subscriber.id%>" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel"><%= subscriber.get_fullname%> (détails)</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <h5>Coordonnées</h5>
            <ul>
              <li><b>email :</b> <%= subscriber.email %></li>
              <li><b>téléphone :</b> <%= subscriber.phone %></li>
            </ul>
            <h5>Recherche</h5>
            <h5>Historique</h5>
            <ul>
              <% SubscriberNote.where(subscriber: subscriber).each do |note| %>
              <li>[<%= note.created_at.strftime("%d-%m-%y") %>] <%= note.content %></li>
              <% end %>
            </ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>