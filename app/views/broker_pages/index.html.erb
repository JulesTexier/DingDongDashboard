<div class="jumbotron jumbotron-fluid">
  <div class="container">
    <h1 class="display-4">Tableau de suivi</h1>
    <p class="lead">Bonjour <%= @broker.firstname%>, bienvenue sur la page de suivi de vos contacts.</p>
    <br>
    <p><%= link_to 'Se deconnecter', destroy_broker_session_path, :method => :delete %><p>
    <p>Votre lien à partager à vos clients: <br>
      <span style="font-style:italic"><%= "#{ENV['BASE_URL']}inscription/courtier/#{@broker.id}" %></span>
    </p>
  </div>
</div>

<div class= "container">
  <div class="row mt-5">
    <div class="col-lg-4 col-12">
      <div class="card" >
        <div class="card-body">
          <h5 class="card-title">7 derniers jours</h5>
          <p class="card-text"><span style="font-size: 2rem"><%= @subscribers_week.count%></span></p>
          <div class= "row">
            <div class="col-4"> <%= @subscribers_week.select{|x| x.hot_lead && !x.is_broker_affiliated }.count %> <br> <span class="badge badge-danger">Chaud</span> </div>
            <div class="col-4"> <%= @subscribers_week.select{|x| !x.hot_lead && !x.is_broker_affiliated }.count %>  <br> <span class="badge badge-light">Froid</span> </div>
            <div class="col-4"> <%= @subscribers_week.select{|x| x.is_broker_affiliated }.count %> <br>  <span class="badge badge-info">Client</span> </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4 col-12">
      <div class="card" >
        <div class="card-body">
          <h5 class="card-title">30 derniers jours</h5>
          <p class="card-text"><span style="font-size: 2rem"><%= @subscribers_month.count%></span></p>
          <div class= "row">
            <div class="col-4"> <%= @subscribers_month.select{|x| x.hot_lead && !x.is_broker_affiliated}.count %> <br> <span class="badge badge-danger">Chaud</span> </div>
            <div class="col-4"> <%= @subscribers_month.select{|x| !x.hot_lead && !x.is_broker_affiliated}.count %>  <br> <span class="badge badge-light">Froid</span> </div>
            <div class="col-4"> <%= @subscribers_month.select{|x| x.is_broker_affiliated }.count %> <br>  <span class="badge badge-info">Client</span> </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Total</h5>
          <p class="card-text"><span style="font-size: 2rem"><%= @subscribers.count%></span></p>
          <div class= "row">
            <div class="col-4"> <%= @subscribers.select{|x| x.hot_lead}.count %> <br> <span class="badge badge-danger">Chaud</span> </div>
            <div class="col-4"> <%= @subscribers.select{|x| !x.hot_lead && !x.is_broker_affiliated}.count %>  <br> <span class="badge badge-light">Froid</span> </div>
            <div class="col-4"> <%= @subscribers.select{|x| x.is_broker_affiliated}.count %> <br>  <span class="badge badge-info">Client</span> </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-3 d-flex flex-column">
    <h5>Légende</h5>
    <ul style="list-style:none">
      <li><span class="badge badge-danger">Chaud</span> : Utilisateur qui a demandé à être mis en relation avec son courtier</li>
      <li><span class="badge badge-light">Froid</span> : Utilisateur qui n'a pas (encore) demandé à être mis en relation avec son courtier</li>
      <li><span class="badge badge-info">Client</span> : Votre client, à qui vous avez donné accès à l'alerte Ding Dong</li>
    </ul>
  </div>

  <div class="row mt-5">
    <table class="table">
      <thead class="thead-dark">
        <tr>
          <th scope="col">Sauvegarder</th>
          <th scope="col">Status</th>
          <th scope="col">Commentaire</th>
          <th scope="col">Nom</th>
          <th scope="col">Actif ?</th>
          <th scope="col">Plus d'infos</th>
        </tr>
      </thead>
      <tbody>
      <% @subscribers.each do |subscriber| %>
        <tr>
          <%= form_tag(broker_checked_path(subscriber.id), remote: true) do %>
          <%=hidden_field_tag 'subscriber_id', subscriber.id %>
            <th class="d-flex justify-content-center">
            <div class="form-check">
              <%= check_box_tag 'checked_by_broker', subscriber.id, subscriber.checked_by_broker,  class:"form-check-input", data: { url: broker_checked_path(subscriber.id),  remote: :true, method: :post } if false %>
                <%= image_submit_tag("data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjQ5NnB0IiB2aWV3Qm94PSIwIDAgNDk2IDQ5NiIgd2lkdGg9IjQ5NnB0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxwYXRoIGQ9Im04IDQxNiA3MiA3MmgxNnYtMTc2aDMwNHYxNzZoODh2LTQ4MGgtNDgwem03Mi0zNDRjMC0xNy42NzE4NzUgMTQuMzI4MTI1LTMyIDMyLTMyaDI3MmMxNy42NzE4NzUgMCAzMiAxNC4zMjgxMjUgMzIgMzJ2MTYwYzAgMTcuNjcxODc1LTE0LjMyODEyNSAzMi0zMiAzMmgtMjcyYy0xNy42NzE4NzUgMC0zMi0xNC4zMjgxMjUtMzItMzJ6bTAgMCIgZmlsbD0iIzU3YTRmZiIvPjxwYXRoIGQ9Im0zMjAgMzQ0aDQ4djExMmgtNDh6bTAgMCIgZmlsbD0iIzU3YTRmZiIvPjxnIGZpbGw9IiMwMDRmYWMiPjxwYXRoIGQ9Im00ODggMGgtNDgwYy00LjQxNzk2OSAwLTggMy41ODIwMzEtOCA4djQwOGMwIDIuMTIxMDk0Ljg0Mzc1IDQuMTU2MjUgMi4zNDM3NSA1LjY1NjI1bDcyIDcyYzEuNSAxLjUgMy41MzUxNTYgMi4zNDM3NSA1LjY1NjI1IDIuMzQzNzVoNDA4YzQuNDE3OTY5IDAgOC0zLjU4MjAzMSA4LTh2LTQ4MGMwLTQuNDE3OTY5LTMuNTgyMDMxLTgtOC04em0tMzg0IDQ4MHYtMTYwaDI4OHYxNjB6bTM3NiAwaC03MnYtMTY4YzAtNC40MTc5NjktMy41ODIwMzEtOC04LThoLTMwNGMtNC40MTc5NjkgMC04IDMuNTgyMDMxLTggOHYxNjhoLTQuNjg3NWwtNjcuMzEyNS02Ny4zMTI1di0zOTYuNjg3NWg0NjR6bTAgMCIvPjxwYXRoIGQ9Im0xMTIgMjcyaDI3MmMyMi4wODIwMzEtLjAyNzM0NCAzOS45NzI2NTYtMTcuOTE3OTY5IDQwLTQwdi0xNjBjLS4wMjczNDQtMjIuMDgyMDMxLTE3LjkxNzk2OS0zOS45NzI2NTYtNDAtNDBoLTI3MmMtMjIuMDgyMDMxLjAyNzM0NC0zOS45NzI2NTYgMTcuOTE3OTY5LTQwIDQwdjE2MGMuMDI3MzQ0IDIyLjA4MjAzMSAxNy45MTc5NjkgMzkuOTcyNjU2IDQwIDQwem0tMjQtMjAwYzAtMTMuMjUzOTA2IDEwLjc0NjA5NC0yNCAyNC0yNGgyNzJjMTMuMjUzOTA2IDAgMjQgMTAuNzQ2MDk0IDI0IDI0djE2MGMwIDEzLjI1MzkwNi0xMC43NDYwOTQgMjQtMjQgMjRoLTI3MmMtMTMuMjUzOTA2IDAtMjQtMTAuNzQ2MDk0LTI0LTI0em0wIDAiLz48cGF0aCBkPSJtMzY4IDMzNmgtNDhjLTQuNDE3OTY5IDAtOCAzLjU4MjAzMS04IDh2MTEyYzAgNC40MTc5NjkgMy41ODIwMzEgOCA4IDhoNDhjNC40MTc5NjkgMCA4LTMuNTgyMDMxIDgtOHYtMTEyYzAtNC40MTc5NjktMy41ODIwMzEtOC04LTh6bS04IDExMmgtMzJ2LTk2aDMyem0wIDAiLz48cGF0aCBkPSJtMTM2IDk2aDIyNGM0LjQxNzk2OSAwIDgtMy41ODIwMzEgOC04cy0zLjU4MjAzMS04LTgtOGgtMjI0Yy00LjQxNzk2OSAwLTggMy41ODIwMzEtOCA4czMuNTgyMDMxIDggOCA4em0wIDAiLz48cGF0aCBkPSJtMTM2IDEyOGgyMjRjNC40MTc5NjkgMCA4LTMuNTgyMDMxIDgtOHMtMy41ODIwMzEtOC04LThoLTIyNGMtNC40MTc5NjkgMC04IDMuNTgyMDMxLTggOHMzLjU4MjAzMSA4IDggOHptMCAwIi8+PHBhdGggZD0ibTEzNiAxNjBoMjI0YzQuNDE3OTY5IDAgOC0zLjU4MjAzMSA4LThzLTMuNTgyMDMxLTgtOC04aC0yMjRjLTQuNDE3OTY5IDAtOCAzLjU4MjAzMS04IDhzMy41ODIwMzEgOCA4IDh6bTAgMCIvPjxwYXRoIGQ9Im0xMzYgMTkyaDExMmM0LjQxNzk2OSAwIDgtMy41ODIwMzEgOC04cy0zLjU4MjAzMS04LTgtOGgtMTEyYy00LjQxNzk2OSAwLTggMy41ODIwMzEtOCA4czMuNTgyMDMxIDggOCA4em0wIDAiLz48L2c+PC9zdmc+", border: 0, width: 20) %>
            </div>
            </th>
            <td scope="row">
              <%= select_tag "broker_status", options_for_select(@broker_status, subscriber.broker_status) %>
            </td>
            <td scope="row">
              <%= text_area_tag 'broker_comment', subscriber.broker_comment,  cols: 25 %>
            </td>
            <td><%= subscriber.get_fullname%></td>
            <td>
            <% unless subscriber.has_stopped? %>
                <span class="badge badge-pill badge-success">Oui</span>
              <%else%>
                <span class="badge badge-light">Non</span>
              <%end%>
            </td>
            <td>
              <button type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#subscriber-<%= subscriber.id%>">
              Voir plus
            </button>
            </td>
          <% end %>
        </tr>
        <tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <% @subscribers.each do |subscriber| %>
    <!-- Subscriber Modal -->
    <div class="modal fade" id="subscriber-<%= subscriber.id%>" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel"><%= subscriber.get_fullname%> (détails)</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <h5>Coordonnées</h5>
            <ul>
              <li><b>email :</b> <%= subscriber.email %></li>
              <li><b>téléphone :</b> <%= subscriber.phone %></li>
            </ul>
            <% unless subscriber.research.nil? %>
              <h5>Recherche</h5>
              <%= render 'subscriber_research', research: subscriber.research %>
            <% end %>
            <h5>Historique</h5>
            <% notes = subscriber.subscriber_notes %>
            <% if notes.empty? %>
              <p style="font-style:italic">Pas d'historique disponible </p>
            <% else %>
              <ul>
                <% notes.each do |note| %>
                <li>[<%= note.created_at.strftime("%d-%m-%y") %>] <%= note.content %></li>
                <% end %>
              </ul>
            <% end %>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>