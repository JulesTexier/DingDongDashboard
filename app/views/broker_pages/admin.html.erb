<div class="jumbotron jumbotron-fluid">
  <div class="container">
    <h1 class="display-4">Pilotage de l'activité des courtiers</h1>
    <br>
  </div>
</div>

<div class= "container">

  <section>
    <h2>Synthèse par agglomerations</h2>
    <table class="table my-4">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Nom</th>
          <th scope="col">Leads depuis le <%= Date.today.at_beginning_of_month.strftime("%d/%m/%Y") %></th>
          <th scope="col">Leads total</th>
          <th scope="col">Météo</th>
          <th scope="col">Météo Courtiers</th>
        </tr>
      </thead>
      <tbody>
        <% @agglomerations.each do |agglo|%>
          <% subscribers_all = [] %>
          <% subscribers_hot = [] %>
          <% subscribers_cold = [] %>
          <% subscribers_cold_offset = [] %>
          <% subscribers_client = [] %>

          <% subscribers_all_month = [] %>
          <% subscribers_hot_month = [] %>
          <% subscribers_cold_month = [] %>
          <% subscribers_cold_offset_month = [] %>
          <% subscribers_client_month = [] %>
          <tr>
            <th scope="row"><%= agglo.id %></th>
            <td><%= agglo.name %></td>
            <td>
              <% @brokers.select{ |b| b.agglomeration_id == agglo.id }.each{ |b| subscribers_all_month.push(b.subscribers.where('created_at > ? ', Date.today.at_beginning_of_month  )) } %> <%= subscribers_all_month.flatten.count %>
              <br>
              <span class="badge badge-light"> <% subscribers_all_month.flatten.each{ |s| subscribers_hot_month.push(s) if (s.hot_lead && !s.is_broker_affiliated ) } %> <%= subscribers_hot_month.count %> 🔥</span>
              <span class="badge badge-light"> <% subscribers_all_month.flatten.each{ |s| subscribers_cold_month.push(s) if (!s.hot_lead && !s.is_broker_affiliated && s.created_at < Time.now - @broker_offset.days) } %> <%= subscribers_cold_month.count %> 🥶</span>
              <span class="badge badge-light"> <% subscribers_all_month.flatten.each{ |s| subscribers_cold_offset_month.push(s) if (!s.hot_lead && !s.is_broker_affiliated && s.created_at >= Time.now - @broker_offset.days) } %> <%= subscribers_cold_offset_month.count %> ⏳</span>
              <span class="badge badge-light"> <% subscribers_all_month.flatten.each{ |s| subscribers_client_month.push(s) if s.is_broker_affiliated } %> <%= subscribers_client_month.count %> 💼</span>
            </td>
            <td>
              <% @brokers.select{ |b| b.agglomeration_id == agglo.id }.each{ |b| subscribers_all.push(b.subscribers) } %> <%= subscribers_all.flatten.count %>
              <br>
              <span class="badge badge-light"> <% subscribers_all.flatten.each{ |s| subscribers_hot.push(s) if (s.hot_lead && !s.is_broker_affiliated ) } %> <%= subscribers_hot.count %> 🔥</span>
              <span class="badge badge-light"> <% subscribers_all.flatten.each{ |s| subscribers_cold.push(s) if (!s.hot_lead && !s.is_broker_affiliated && s.created_at < Time.now - @broker_offset.days) } %> <%= subscribers_cold.count %> 🥶</span>
              <span class="badge badge-light"> <% subscribers_all.flatten.each{ |s| subscribers_cold_offset.push(s) if (!s.hot_lead && !s.is_broker_affiliated && s.created_at >= Time.now - @broker_offset.days) } %> <%= subscribers_cold_offset.count %> ⏳</span>
              <span class="badge badge-light"> <% subscribers_all.flatten.each{ |s| subscribers_client.push(s) if s.is_broker_affiliated } %> <%= subscribers_client.count %> 💼</span>
            </td>
            <td>
              <% if Time.now.strftime("%d").to_i*0.66*@brokers.select{ |b| b.agglomeration_id == agglo.id }.count > (subscribers_all_month.flatten.count - subscribers_client_month.count)%>
                🟥
              <% else %>
                🟩
              <% end %>
            </td>
            <td>
              <ul style="list-style:none">
              <% @brokers.select{ |b| b.agglomeration_id == agglo.id }.each do |b| %>
                <li>
                  <% broker_subs = [] %>
                  <% broker_subs_client = [] %>
                  <% subscribers_all_month.flatten.each{|s| broker_subs.push(s) if (s.broker == b && !s.is_broker_affiliated) } %>
                  <% if Time.now.strftime("%d").to_i*0.66 > broker_subs.count %>
                    🟥
                  <% elsif  broker_subs.count >= 20 %>
                    ✅
                  <% else  %>
                    🟩
                  <% end %>
                  <%= link_to "#{b.get_fullname} (#{broker_subs.count})", "/courtier/#{b.id}/dashboard" %>
                </li>
              <% end %>
              </ul>
            </td>
          </tr>
        <%end%>
      </tbody>
    </table>
  </section>
</div>