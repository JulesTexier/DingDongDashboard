<div class="jumbotron jumbotron-fluid">
  <div class="container">
    <h1 class="display-4">Tableau de suivi</h1>
    <p class="lead">Bonjour <%= @broker.firstname%>, bienvenue sur la page de suivi de vos contacts.</p>
    <br>
    <p><%= link_to 'Se deconnecter', destroy_broker_session_path, :method => :delete %><p>
    <p>Votre lien à partager à vos clients: <br>
      <span style="font-style:italic"><%= "#{ENV['BASE_URL']}inscription/courtier/#{@broker.id}" %></span>
    </p>
  </div>
</div>

<div class= "container">
  <div class="row mt-5">
    <div class="col-lg-4 col-12">
      <div class="card" >
        <div class="card-body">
          <h5 class="card-title">7 derniers jours</h5>
          <p class="card-text"><span style="font-size: 2rem"><%= @subscribers_week.count%></span></p>
          <div class= "row">
            <div class="col-4"> <%= @subscribers_week.select{|x| x.hot_lead && !x.is_broker_affiliated }.count %> <br> <span class="badge badge-danger">Chaud</span> </div>
            <div class="col-4"> <%= @subscribers_week.select{|x| !x.hot_lead && !x.is_broker_affiliated }.count %>  <br> <span class="badge badge-light">Froid</span> </div>
            <div class="col-4"> <%= @subscribers_week.select{|x| x.is_broker_affiliated }.count %> <br>  <span class="badge badge-info">Client</span> </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4 col-12">
      <div class="card" >
        <div class="card-body">
          <h5 class="card-title">30 derniers jours</h5>
          <p class="card-text"><span style="font-size: 2rem"><%= @subscribers_month.count%></span></p>
          <div class= "row">
            <div class="col-4"> <%= @subscribers_month.select{|x| x.hot_lead && !x.is_broker_affiliated}.count %> <br> <span class="badge badge-danger">Chaud</span> </div>
            <div class="col-4"> <%= @subscribers_month.select{|x| !x.hot_lead && !x.is_broker_affiliated}.count %>  <br> <span class="badge badge-light">Froid</span> </div>
            <div class="col-4"> <%= @subscribers_month.select{|x| x.is_broker_affiliated }.count %> <br>  <span class="badge badge-info">Client</span> </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-12">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Total</h5>
          <p class="card-text"><span style="font-size: 2rem"><%= @subscribers.count%></span></p>
          <div class= "row">
            <div class="col-4"> <%= @subscribers.select{|x| x.hot_lead}.count %> <br> <span class="badge badge-danger">Chaud</span> </div>
            <div class="col-4"> <%= @subscribers.select{|x| !x.hot_lead && !x.is_broker_affiliated}.count %>  <br> <span class="badge badge-light">Froid</span> </div>
            <div class="col-4"> <%= @subscribers.select{|x| x.is_broker_affiliated}.count %> <br>  <span class="badge badge-info">Client</span> </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-3 d-flex flex-column">
    <h5>Légende</h5>
    <ul style="list-style:none">
      <li><span class="badge badge-danger">Chaud</span> : Utilisateur qui a demandé à être mis en relation avec son courtier</li>
      <li><span class="badge badge-light">Froid</span> : Utilisateur qui n'a pas (encore) demandé à être mis en relation avec son courtier</li>
      <li><span class="badge badge-info">Client</span> : Votre client, à qui vous avez donné accès à l'alerte Ding Dong</li>
    </ul>
  </div>

  <div class="row mt-5">
    <table class="table">
      <thead class="thead-dark">
        <tr>
          <th scope="col">Sauvegarder</th>
          <th scope="col">Status</th>
          <th scope="col">Commentaire</th>
          <th scope="col">Nom</th>
          <th scope="col">Actif ?</th>
          <th scope="col">Plus d'infos</th>
        </tr>
      </thead>
      <tbody>
      <% @subscribers.each do |subscriber| %>
        <tr>
          <%= form_tag(broker_checked_path, method: :post, remote: true) do %>
          <%=hidden_field_tag 'subscriber_id', subscriber.id %>
            <th class="d-flex justify-content-center">
            <div class="form-check">
              <%= check_box_tag 'checked_by_broker', subscriber.id, subscriber.checked_by_broker,  class:"form-check-input", data: { url: broker_checked_path(subscriber.id),  remote: :true, method: :post } if false %>
                <%= image_submit_tag("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE5LjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJDYXBhXzEiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiIHg9IjBweCIgeT0iMHB4Ig0KCSB2aWV3Qm94PSIwIDAgNDY4LjI5MyA0NjguMjkzIiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA0NjguMjkzIDQ2OC4yOTM7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4NCjxwYXRoIHN0eWxlPSJmaWxsOiMyRDkyQkE7IiBkPSJNNDMzLjk1MSw0NjguMjkzSDM0LjM0MWMtMTAuMzQ1LDAtMTguNzMyLTguMzg2LTE4LjczMi0xOC43MzJWMTguNzMyQzE1LjYxLDguMzg2LDIzLjk5NiwwLDM0LjM0MSwwDQoJaDM0NS44MmMyOC4zMjIsMjguMzIyLDQ0LjIsNDQuMiw3Mi41MjIsNzIuNTIydjM3Ny4wMzlDNDUyLjY4Myw0NTkuOTA2LDQ0NC4yOTYsNDY4LjI5Myw0MzMuOTUxLDQ2OC4yOTN6Ii8+DQo8cGF0aCBzdHlsZT0iZmlsbDojRTBFNUU4OyIgZD0iTTMyMi42NDgsMTc3LjUxOEgxMTguMTkxYy0xMC4zNDUsMC0xOC43MzItOC4zODYtMTguNzMyLTE4LjczMlYwaDI0MS45MnYxNTguNzg3DQoJQzM0MS4zOCwxNjkuMTMyLDMzMi45OTQsMTc3LjUxOCwzMjIuNjQ4LDE3Ny41MTh6Ii8+DQo8cGF0aCBzdHlsZT0iZmlsbDojNjQ3OTg5OyIgZD0iTTI4MS43ODIsMTUxLjE5OGgtNDMuNzA3Yy0zLjQ0OCwwLTYuMjQ0LTIuNzk2LTYuMjQ0LTYuMjQ0VjMyLjU2NGMwLTMuNDQ4LDIuNzk2LTYuMjQ0LDYuMjQ0LTYuMjQ0DQoJaDQzLjcwN2MzLjQ0OCwwLDYuMjQ0LDIuNzk1LDYuMjQ0LDYuMjQ0djExMi4zOUMyODguMDI2LDE0OC40MDMsMjg1LjIzLDE1MS4xOTgsMjgxLjc4MiwxNTEuMTk4eiIvPg0KPGc+DQoJPHBhdGggc3R5bGU9ImZpbGw6IzNCNTY2QTsiIGQ9Ik04NS41MjcsNDQzLjQyNkg0MS44MnYtMzcuNDYzYzAtMy40NDgsMi43OTUtNi4yNDQsNi4yNDQtNi4yNDRoMzEuMjINCgkJYzMuNDQ4LDAsNi4yNDQsMi43OTUsNi4yNDQsNi4yNDRWNDQzLjQyNnoiLz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojM0I1NjZBOyIgZD0iTTQyNi40NzMsNDQzLjQyNmgtNDMuNzA3di0zNy40NjNjMC0zLjQ0OCwyLjc5Ni02LjI0NCw2LjI0NC02LjI0NGgzMS4yMg0KCQljMy40NDgsMCw2LjI0NCwyLjc5NSw2LjI0NCw2LjI0NFY0NDMuNDI2eiIvPg0KPC9nPg0KPGc+DQoJPHJlY3QgeD0iNDEuODIyIiB5PSI0MzMuMzA4IiBzdHlsZT0iZmlsbDojRDRENURCOyIgd2lkdGg9IjQzLjcwNyIgaGVpZ2h0PSIxMC4xMTUiLz4NCgk8cmVjdCB4PSIzODIuNzY0IiB5PSI0MzMuMzA4IiBzdHlsZT0iZmlsbDojRDRENURCOyIgd2lkdGg9IjQzLjcwNyIgaGVpZ2h0PSIxMC4xMTUiLz4NCjwvZz4NCjxwYXRoIHN0eWxlPSJmaWxsOiNFQkVGRjI7IiBkPSJNMzU5LjAwOSwzMDIuMDc2djE2Ni4yMTJIMTA5LjMxNVYzMDIuMDc2YzAtMTAuMzY2LDguMzY3LTE4LjczMiwxOC43MzItMTguNzMyaDIxMi4yMw0KCUMzNTAuNTgsMjgzLjM0NCwzNTkuMDA5LDI5MS43MSwzNTkuMDA5LDMwMi4wNzZ6Ii8+DQo8cGF0aCBzdHlsZT0iZmlsbDojNEVCRDlFOyIgZD0iTTM1OS4wMDksMzAyLjA3NnYyNS44NDlIMTA5LjMxNXYtMjUuODQ5YzAtMTAuMzY2LDguMzY3LTE4LjczMiwxOC43MzItMTguNzMyaDIxMi4yMw0KCUMzNTAuNTgsMjgzLjM0NCwzNTkuMDA5LDI5MS43MSwzNTkuMDA5LDMwMi4wNzZ6Ii8+DQo8Zz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojRDRENURCOyIgZD0iTTMzNC4wNjUsMzU0Ljg4MUgxMzQuMjU5Yy0zLjQ1MSwwLTYuMjQ0LDIuNzk2LTYuMjQ0LDYuMjQ0YzAsMy40NDgsMi43OTMsNi4yNDQsNi4yNDQsNi4yNDQNCgkJaDE5OS44MDZjMy40NTEsMCw2LjI0NC0yLjc5Niw2LjI0NC02LjI0NEMzNDAuMzA5LDM1Ny42NzYsMzM3LjUxNiwzNTQuODgxLDMzNC4wNjUsMzU0Ljg4MXoiLz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojRDRENURCOyIgZD0iTTMzNC4wNjUsMzkxLjEyM0gxMzQuMjU5Yy0zLjQ1MSwwLTYuMjQ0LDIuNzk2LTYuMjQ0LDYuMjQ0YzAsMy40NDgsMi43OTMsNi4yNDQsNi4yNDQsNi4yNDQNCgkJaDE5OS44MDZjMy40NTEsMCw2LjI0NC0yLjc5Niw2LjI0NC02LjI0NEMzNDAuMzA5LDM5My45MTksMzM3LjUxNiwzOTEuMTIzLDMzNC4wNjUsMzkxLjEyM3oiLz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojRDRENURCOyIgZD0iTTMzNC4wNjUsNDI3LjM2NUgxMzQuMjU5Yy0zLjQ1MSwwLTYuMjQ0LDIuNzk2LTYuMjQ0LDYuMjQ0YzAsMy40NDgsMi43OTMsNi4yNDQsNi4yNDQsNi4yNDQNCgkJaDE5OS44MDZjMy40NTEsMCw2LjI0NC0yLjc5Niw2LjI0NC02LjI0NEMzNDAuMzA5LDQzMC4xNjEsMzM3LjUxNiw0MjcuMzY1LDMzNC4wNjUsNDI3LjM2NXoiLz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjwvc3ZnPg0K" , border: 0, width: 30) %>
            </div>
            </th>
            <td scope="row">
              <%= select_tag "broker_status", options_for_select(@broker_status, subscriber.broker_status) %>
            </td>
            <td scope="row">
              <%= text_area_tag 'broker_comment', subscriber.broker_comment,  cols: 25 %>
            </td>
            <td><%= subscriber.get_fullname%></td>
            <td>
            <% unless subscriber.has_stopped? %>
                <span class="badge badge-pill badge-success">Oui</span>
              <%else%>
                <span class="badge badge-light">Non</span>
              <%end%>
            </td>
            <td>
              <button type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#subscriber-<%= subscriber.id%>">
              Voir plus
            </button>
            </td>
          <% end %>
        </tr>
        <tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <% @subscribers.each do |subscriber| %>
    <!-- Subscriber Modal -->
    <div class="modal fade" id="subscriber-<%= subscriber.id%>" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel"><%= subscriber.get_fullname%> (détails)</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <h5>Coordonnées</h5>
            <ul>
              <li><b>email :</b> <%= subscriber.email %></li>
              <li><b>téléphone :</b> <%= subscriber.phone %></li>
            </ul>
            <% unless subscriber.research.nil? %>
              <h5>Recherche</h5>
              <%= render 'subscriber_research', research: subscriber.research %>
            <% end %>
            <h5>Historique</h5>
            <% notes = subscriber.subscriber_notes %>
            <% if notes.empty? %>
              <p style="font-style:italic">Pas d'historique disponible </p>
            <% else %>
              <ul>
                <% notes.each do |note| %>
                <li>[<%= note.created_at.strftime("%d-%m-%y") %>] <%= note.content %></li>
                <% end %>
              </ul>
            <% end %>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>